<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå¾‹çš„æœè–ä¹‹æ—…</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-coral: #E57373; --soft-rose: #D4A5A5; --earth-bg: #F5F2ED; --card-white: #FFFFFF;
            --text-main: #5D5451; --text-sub: #8D837F; --weekly-blue: #9DAFBD; --monthly-purple: #B0A4B1; --disabled-gray: #E0D6D1;
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--earth-bg); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #E8D7D0 0%, #D4A5A5 100%); color: var(--text-main); width: 100%; box-shadow: 0 2px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        nav { display: flex; gap: 10px; margin-top: -22px; z-index: 10; }
        nav button { padding: 10px 25px; border: none; border-radius: 20px; background: var(--card-white); color: var(--text-sub); cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: 0.3s; font-weight: bold; }
        nav button.active { background: var(--primary-coral); color: white; }
        .container { width: 92%; max-width: 550px; margin-top: 35px; padding-bottom: 60px; }
        .stats-panel { background: var(--card-white); border-radius: 18px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .panel-title { font-weight: bold; margin-bottom: 15px; display: block; font-size: 0.95rem; }
        
        /* æ—¥æ›† Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .weekday-label { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); padding-bottom: 5px; }
        .calendar-cell { aspect-ratio: 0.8; border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding-top: 5px; font-size: 0.7rem; background: #F9F7F5; transition: 0.3s; color: var(--text-sub); cursor: pointer; border: 2px solid transparent; }
        .calendar-cell.active-edit { border-color: var(--primary-coral); background: #FFF; box-shadow: 0 0 8px rgba(229,115,115,0.3); }
        .cell-perfect { background-color: var(--primary-coral) !important; color: white !important; }
        .cell-good { background-color: #F8BDBD !important; color: white !important; }
        .cell-started { background-color: #EAE3DC !important; color: var(--text-main) !important; }

        .emoji-heart { color: #FF6B6B; font-style: normal; }
        .emoji-broken { filter: grayscale(100%) brightness(0%); display: inline-block; font-style: normal; }
        .emoji-trail { font-size: 0.5rem; line-height: 1.1; margin-top: 3px; word-break: break-all; }
        
        .item-card { background: var(--card-white); padding: 16px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 4px solid transparent; transition: 0.3s; }
        .item-card.completed { border-left-color: var(--soft-rose); }
        .item-card.completed span { text-decoration: line-through; color: #B5A9A4; }
        .item-card.rest-day { background: #F0EDE9; opacity: 0.5; cursor: not-allowed; border-left-color: var(--disabled-gray); }
        
        .sweets-zone { flex-direction: column; align-items: flex-start; gap: 12px; border-left: 4px solid #333; }
        .sweets-row { display: flex; width: 100%; justify-content: space-between; align-items: center; }
        .heart-btn { background: #F9F7F5; border: 1px solid #EEE; border-radius: 20px; padding: 6px 15px; cursor: pointer; font-size: 0.85rem; }
        
        .progress-bar-bg { height: 8px; background: #EAE3DC; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--primary-coral); transition: 0.6s ease; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--primary-coral); cursor: pointer; }

        .weekly-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .week-box { padding: 15px 5px; border-radius: 10px; background: #EEE; text-align: center; font-size: 0.8rem; }
        .week-done { background: var(--weekly-blue); color: white; }
        .monthly-track { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .month-circle { aspect-ratio: 1; border-radius: 50%; background: #EEE; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; transition: 0.3s; }
        .month-done { background: var(--monthly-purple); color: white; }
    </style>
</head>
<body>
<header>
    <h1>è‡ªå¾‹çš„æœè–ä¹‹æ—…</h1>
    <div id="current-date" style="font-size:1.0rem; font-weight:bold; margin-top:8px; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px; display:inline-block;"></div>
</header>
<nav>
    <button onclick="showTab('daily')" id="btn-daily" class="active">æ¯æ—¥ä¿®ç…‰</button>
    <button onclick="showTab('weekly')" id="btn-weekly">æ¯é€±é‡Œç¨‹</button>
    <button onclick="showTab('monthly')" id="btn-monthly">æ¯æœˆæ”¶ç©«</button>
</nav>
<div class="container">
    <div id="panel-daily" class="stats-panel">
        <span class="panel-title" id="cal-title">æˆé•·è»Œè·¡</span>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>
    
    <div id="panel-weekly" class="stats-panel" style="display:none;"><span class="panel-title" id="week-panel-title">æœ¬æœˆé€±æ¬¡é‡Œç¨‹</span><div class="weekly-grid" id="weekly-grid"></div></div>
    <div id="panel-monthly" class="stats-panel" style="display:none;"><span class="panel-title">å¹´åº¦é”æ¨™è¶³è·¡</span><div class="monthly-track" id="monthly-track"></div></div>
    
    <div class="stats-panel" style="padding:15px; margin-top:-10px;">
        <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span id="tab-title-display">é€²åº¦è¿½è¹¤</span>
            <span id="percent-text">0%</span>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill"></div></div>
    </div>

    <div id="daily" class="tab-content active">
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>æœ‰æ°§é‹å‹•</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>é‡é‡è¨“ç·´</span></div>
        <div class="item-card" data-days="1,2,3,4,5,6"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>è‹±èªå–®å­—èˆ‡è½åŠ›</span></div>
        <div class="item-card" data-days="1,2,3,4,5"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>é†«å­¸å°ˆæ¥­ç ”è®€</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>éœå¿ƒé–±è®€æ™‚é–“</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>åé»å‰å°±å¯¢</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>å¿ƒæƒ…å¹³ç©©ä¸é·æ€’</span></div>
        
        <div class="item-card sweets-zone">
            <div style="font-weight: bold; font-size: 0.9rem;">ğŸ° ç³•é»æ„å¿—åŠ›æŒ‘æˆ°</div>
            <div class="sweets-row">
                <span>å¿ä½è³¼è²·ç³•é»çš„è¡å‹•</span>
                <button class="heart-btn" onclick="addHeart('â¤ï¸')">â¤ï¸ å¿ä½äº†</button>
            </div>
            <div class="sweets-row">
                <span>ç„¡æ³•å¿ä½è¡å‹•ï¼Œè³¼è²·äº†ç³•é»</span>
                <button class="heart-btn" onclick="addHeart('ğŸ’”')">ğŸ’” è³¼è²·äº†</button>
            </div>
            <div id="today-emoji-status" style="font-size: 0.8rem; margin-top: 5px; color: var(--text-sub);">ä»Šæ—¥è¨˜éŒ„ï¼šå°šæœªæœ‰è³‡æ–™</div>
        </div>
    </div>

    <div id="weekly" class="tab-content">
        <div class="item-card"><input type="checkbox" id="week-cardio-cb" disabled> <span>æœ‰æ°§é‹å‹• â‰¥ 3æ¬¡/é€±</span><span id="cardio-count-label" style="font-size:0.7rem; color:var(--primary-coral); font-weight:bold; margin-left:auto;">0/3</span></div>
        <div class="item-card"><input type="checkbox" id="week-strength-cb" disabled> <span>é‡é‡è¨“ç·´ â‰¥ 2æ¬¡/é€±</span><span id="strength-count-label" style="font-size:0.7rem; color:var(--primary-coral); font-weight:bold; margin-left:auto;">0/2</span></div>
    </div>
    <div id="monthly" class="tab-content">
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>é«”é‡ç¶­æŒ < 58 kg</span></div>
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>é«”è„‚ç‡ç¶­æŒ < 25%</span></div>
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>æœˆé–‹æ”¯æ§åˆ¶ < 250,000</span></div>
    </div>
</div>

<script>
    let activeDate = new Date();
    let currentTab = 'daily';
    // ç‚ºäº†ç¢ºä¿ç‰ˆæœ¬ä¹¾æ·¨ï¼Œæ›´æ›å­˜æª”éµå
    let db = JSON.parse(localStorage.getItem('goal_final_v24')) || { daily_history: {}, daily_ticks: {}, daily_emojis: {}, weekly: {}, monthly: {} };

    function fireCheckboxConfetti(el) { if (el.checked) confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#E57373', '#D4A5A5', '#FFF'] }); }

    function initPage() {
        loadDayData(new Date()); 
    }

    function loadDayData(targetDate) {
        activeDate = new Date(targetDate);
        const key = activeDate.toDateString();
        const dayOfWeek = activeDate.getDay();
        
        document.getElementById('current-date').innerText = activeDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        const ticks = db.daily_ticks[key] || [];
        document.querySelectorAll('#daily .item-card:not(.sweets-zone)').forEach((item, i) => {
            const allowed = item.getAttribute('data-days');
            const cb = item.querySelector('input');
            if (allowed) {
                const isRest = !allowed.split(',').includes(dayOfWeek.toString());
                item.classList.toggle('rest-day', isRest);
                cb.disabled = isRest;
            } else {
                item.classList.remove('rest-day');
                cb.disabled = false;
            }
            cb.checked = !cb.disabled && (ticks[i] || false);
        });

        updateEmojiUI();
        update(false); 
        refreshStats();
    }

    function addHeart(emoji) {
        const key = activeDate.toDateString();
        db.daily_emojis[key] = (db.daily_emojis[key] || "") + emoji;
        if (emoji === 'â¤ï¸') confetti({ particleCount: 60, spread: 80, origin: { y: 0.8 }, colors: ['#FF6B6B'] });
        updateEmojiUI();
        update(); // é€™æœƒè§¸ç™¼å­˜æª”ä¸¦é‡æ–°è¨ˆç®—é€²åº¦æ¢
    }

    function formatEmojis(str) {
        if (!str) return "";
        return str.split('').map(char => {
            if (char === 'â¤ï¸') return `<span class="emoji-heart">â¤ï¸</span>`;
            if (char === 'ğŸ’”') return `<span class="emoji-broken">ğŸ’”</span>`;
            return char;
        }).join('');
    }

    function updateEmojiUI() {
        const raw = db.daily_emojis[activeDate.toDateString()] || "";
        document.getElementById('today-emoji-status').innerHTML = `ä»Šæ—¥æˆ°æ³ï¼š${formatEmojis(raw) || 'å°šæœªæœ‰è³‡æ–™'}`;
    }

    function update(save = true) {
        const key = activeDate.toDateString();
        const activeTab = document.getElementById(currentTab);
        const inputs = Array.from(activeTab.querySelectorAll('input[type="checkbox"]'));
        const activeInputs = inputs.filter(i => !i.disabled);
        const checked = activeInputs.filter(i => i.checked);
        let percent = activeInputs.length ? Math.round((checked.length / activeInputs.length) * 100) : 0;
        
        if(currentTab === 'daily') {
            const emo = db.daily_emojis[key] || "";
            const h = (emo.match(/â¤ï¸/g) || []).length;
            const b = (emo.match(/ğŸ’”/g) || []).length;
            percent = Math.min(100, Math.max(0, percent + h - b));
            
            inputs.forEach(i => {
                if(i.parentElement.classList.contains('item-card')) {
                    i.parentElement.classList.toggle('completed', i.checked);
                }
            });

            if(save) {
                db.daily_history[key] = percent;
                db.daily_ticks[key] = Array.from(document.querySelectorAll('#daily input[type="checkbox"]')).map(i => i.checked);
                checkWeeklyAuto();
            }
        } else if(currentTab === 'monthly') {
            db.monthly[`${activeDate.getFullYear()}-M${activeDate.getMonth()+1}`] = (percent === 100);
        }

        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('percent-text').innerText = percent + '%';

        if(save) {
            refreshStats();
            localStorage.setItem('goal_final_v24', JSON.stringify(db));
        }
    }

    function checkWeeklyAuto() {
        const start = new Date(activeDate);
        start.setDate(start.getDate() - start.getDay());
        let c=0, s=0;
        for(let i=0; i<7; i++){
            const ticks = db.daily_ticks[new Date(start).toDateString()];
            if(ticks){ if(ticks[0]) c++; if(ticks[1]) s++; }
            start.setDate(start.getDate()+1);
        }
        document.getElementById('cardio-count-label').innerText = `${c}/3`;
        document.getElementById('strength-count-label').innerText = `${s}/2`;
        const cbC = document.getElementById('week-cardio-cb'), cbS = document.getElementById('week-strength-cb');
        cbC.checked = (c>=3); cbS.checked = (s>=2);
        const wIdx = Math.ceil((activeDate.getDate() + new Date(activeDate.getFullYear(), activeDate.getMonth(), 1).getDay()) / 7);
        db.weekly[`${activeDate.getFullYear()}-${activeDate.getMonth()+1}-W${wIdx}`] = (cbC.checked && cbS.checked);
    }

    function refreshStats() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w => {
            const el = document.createElement('div'); el.className = 'weekday-label'; el.innerText = w; grid.appendChild(el);
        });

        const year = activeDate.getFullYear(), month = activeDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for(let i=0; i<firstDay; i++){ grid.appendChild(document.createElement('div')); }

        for(let d=1; d<=daysInMonth; d++){
            const dObj = new Date(year, month, d);
            const dKey = dObj.toDateString();
            const p = db.daily_history[dKey] || 0;
            const emo = db.daily_emojis[dKey] || "";
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            if(dKey === activeDate.toDateString()) cell.classList.add('active-edit');
            if (p >= 100) cell.classList.add('cell-perfect');
            else if (p >= 50) cell.classList.add('cell-good');
            else if (p > 0) cell.classList.add('cell-started');
            
            cell.innerHTML = `<b>${d}</b><span style="font-size:0.5rem">${p}%</span><div class="emoji-trail">${formatEmojis(emo)}</div>`;
            cell.onclick = () => loadDayData(dObj);
            grid.appendChild(cell);
        }

        const wGrid = document.getElementById('weekly-grid'); wGrid.innerHTML = '';
        for(let w=1; w<=5; w++){
            const done = db.weekly[`${year}-${month+1}-W${w}`];
            const box = document.createElement('div');
            box.className = 'week-box' + (done?' week-done':''); box.innerText = `ç¬¬${w}é€±`; wGrid.appendChild(box);
        }
        const mTrack = document.getElementById('monthly-track'); mTrack.innerHTML = '';
        for(let m=1; m<=12; m++){
            const done = db.monthly[`${year}-M${m}`];
            const circle = document.createElement('div');
            circle.className = 'month-circle' + (done?' month-done':''); circle.innerText = m+'æœˆ'; mTrack.appendChild(circle);
        }
    }

    function showTab(id) {
        currentTab = id;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('panel-daily').style.display = (id === 'daily' ? 'block' : 'none');
        document.getElementById('panel-weekly').style.display = (id === 'weekly' ? 'block' : 'none');
        document.getElementById('panel-monthly').style.display = (id === 'monthly' ? 'block' : 'none');
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-'+id).classList.add('active');
        update(false);
    }

    window.onload = initPage;
</script>
</body>
</html>