<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå¾‹çš„æœè–ä¹‹æ—…</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-coral: #E57373; --soft-rose: #D4A5A5; --earth-bg: #F5F2ED; --card-white: #FFFFFF;
            --text-main: #5D5451; --text-sub: #8D837F; --weekly-blue: #9DAFBD; --monthly-purple: #B0A4B1; --disabled-gray: #E0D6D1;
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--earth-bg); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #E8D7D0 0%, #D4A5A5 100%); color: var(--text-main); width: 100%; box-shadow: 0 2px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        nav { display: flex; gap: 10px; margin-top: -22px; z-index: 10; }
        nav button { padding: 10px 25px; border: none; border-radius: 20px; background: var(--card-white); color: var(--text-sub); cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: 0.3s; font-weight: bold; }
        nav button.active { background: var(--primary-coral); color: white; }
        .container { width: 92%; max-width: 550px; margin-top: 35px; padding-bottom: 60px; }
        .stats-panel { background: var(--card-white); border-radius: 18px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .panel-title { font-weight: bold; margin-bottom: 15px; display: block; font-size: 0.95rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .weekday-label { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); padding-bottom: 5px; }
        .calendar-cell { aspect-ratio: 0.8; border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding-top: 5px; font-size: 0.7rem; background: #F9F7F5; transition: 0.3s; color: var(--text-sub); cursor: pointer; border: 2px solid transparent; }
        .calendar-cell.active-edit { border-color: var(--primary-coral); background: #FFF; box-shadow: 0 0 8px rgba(229,115,115,0.3); }
        .cell-perfect { background-color: var(--primary-coral) !important; color: white !important; }
        .cell-good { background-color: #F8BDBD !important; color: white !important; }
        .cell-started { background-color: #EAE3DC !important; color: var(--text-main) !important; }
        .emoji-heart { color: #FF6B6B; font-style: normal; }
        .emoji-broken { filter: grayscale(100%) brightness(0%); display: inline-block; font-style: normal; }
        .emoji-trail { font-size: 0.5rem; line-height: 1.1; margin-top: 3px; word-break: break-all; }
        .item-card { background: var(--card-white); padding: 16px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border-left: 4px solid transparent; transition: 0.3s; }
        .item-card.completed { border-left-color: var(--soft-rose); }
        .item-card.completed span { text-decoration: line-through; color: #B5A9A4; }
        .item-card.rest-day { background: #F0EDE9; opacity: 0.5; cursor: not-allowed; border-left-color: var(--disabled-gray); }
        .sweets-zone { flex-direction: column; align-items: flex-start; gap: 12px; border-left: 4px solid #333; }
        .sweets-row { display: flex; width: 100%; justify-content: space-between; align-items: center; }
        .heart-btn { background: #F9F7F5; border: 1px solid #EEE; border-radius: 20px; padding: 6px 15px; cursor: pointer; font-size: 0.85rem; }
        .progress-bar-bg { height: 8px; background: #EAE3DC; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--primary-coral); transition: 0.6s ease; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--primary-coral); cursor: pointer; }
        .weekly-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .week-box { padding: 15px 5px; border-radius: 10px; background: #EEE; text-align: center; font-size: 0.8rem; cursor: pointer; border: 2px solid transparent; }
        .week-box.active-week { border-color: var(--weekly-blue); background: #FFF; box-shadow: 0 0 8px rgba(157,175,189,0.3); }
        .week-done { background: var(--weekly-blue) !important; color: white !important; }
        .monthly-track { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .month-circle { aspect-ratio: 1; border-radius: 50%; background: #EEE; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; transition: 0.3s; cursor: pointer; border: 2px solid transparent; }
        .month-circle.active-month { border-color: var(--monthly-purple); background: #FFF; box-shadow: 0 0 8px rgba(176,164,177,0.3); }
        .month-done { background: var(--monthly-purple) !important; color: white !important; }
    </style>
</head>
<body>
<header>
    <h1>è‡ªå¾‹çš„æœè–ä¹‹æ—…</h1>
    <div id="current-date" style="font-size:1.0rem; font-weight:bold; margin-top:8px; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px; display:inline-block;"></div>
</header>
<nav>
    <button onclick="showTab('daily')" id="btn-daily" class="active">æ¯æ—¥ä¿®ç…‰</button>
    <button onclick="showTab('weekly')" id="btn-weekly">æ¯é€±é‡Œç¨‹</button>
    <button onclick="showTab('monthly')" id="btn-monthly">æ¯æœˆæ”¶ç©«</button>
</nav>
<div class="container">
    <div id="panel-daily" class="stats-panel">
        <span class="panel-title" id="cal-title">æˆé•·è»Œè·¡</span>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>
    <div id="panel-weekly" class="stats-panel" style="display:none;"><span class="panel-title" id="week-panel-title">æœ¬æœˆé€±æ¬¡é‡Œç¨‹</span><div class="weekly-grid" id="weekly-grid"></div></div>
    <div id="panel-monthly" class="stats-panel" style="display:none;"><span class="panel-title">å¹´åº¦é”æ¨™è¶³è·¡</span><div class="monthly-track" id="monthly-track"></div></div>
    <div class="stats-panel" style="padding:15px; margin-top:-10px;">
        <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span id="tab-title-display">é€²åº¦è¿½è¹¤</span>
            <span id="percent-text">0%</span>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill"></div></div>
    </div>
    <div id="daily" class="tab-content active">
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>æœ‰æ°§é‹å‹•</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>é‡é‡è¨“ç·´</span></div>
        <div class="item-card" data-days="1,2,3,4,5,6"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>è‹±èªå–®å­—èˆ‡è½åŠ›</span></div>
        <div class="item-card" data-days="1,2,3,4,5"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>é†«å­¸å°ˆæ¥­ç ”è®€</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>éœå¿ƒé–±è®€æ™‚é–“</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>åé»å‰å°±å¯¢</span></div>
        <div class="item-card"><input type="checkbox" onchange="fireCheckboxConfetti(this); update();"> <span>å¿ƒæƒ…å¹³ç©©ä¸é·æ€’</span></div>
        <div class="item-card sweets-zone">
            <div style="font-weight: bold; font-size: 0.9rem;">ğŸ° ç³•é»æ„å¿—åŠ›æŒ‘æˆ°</div>
            <div class="sweets-row"><span>å¿ä½è³¼è²·ç³•é»çš„è¡å‹•</span><button class="heart-btn" onclick="addHeart('â¤ï¸')">â¤ï¸ å¿ä½äº†</button></div>
            <div class="sweets-row"><span>ç„¡æ³•å¿ä½è¡å‹•ï¼Œè³¼è²·äº†ç³•é»</span><button class="heart-btn" onclick="addHeart('ğŸ’”')">ğŸ’” è³¼è²·äº†</button></div>
            <div id="today-emoji-status" style="font-size: 0.8rem; margin-top: 5px; color: var(--text-sub);">ä»Šæ—¥è¨˜éŒ„ï¼šå°šæœªæœ‰è³‡æ–™</div>
        </div>
    </div>
    <div id="weekly" class="tab-content">
        <div class="item-card"><input type="checkbox" id="week-cardio-cb" onchange="update();"> <span>æœ‰æ°§é‹å‹• â‰¥ 3æ¬¡/é€±</span><span id="cardio-count-label" style="font-size:0.7rem; color:var(--primary-coral); font-weight:bold; margin-left:auto;">0/3</span></div>
        <div class="item-card"><input type="checkbox" id="week-strength-cb" onchange="update();"> <span>é‡é‡è¨“ç·´ â‰¥ 2æ¬¡/é€±</span><span id="strength-count-label" style="font-size:0.7rem; color:var(--primary-coral); font-weight:bold; margin-left:auto;">0/2</span></div>
    </div>
    <div id="monthly" class="tab-content">
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>é«”é‡ç¶­æŒ < 58 kg</span></div>
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>é«”è„‚ç‡ç¶­æŒ < 25%</span></div>
        <div class="item-card"><input type="checkbox" onchange="update();"> <span>æœˆé–‹æ”¯æ§åˆ¶ < 250,000</span></div>
    </div>
</div>
<script>
    let activeDate = new Date();
    let currentTab = 'daily';
    let selectedWeek = 1;
    let selectedMonth = new Date().getMonth() + 1; // è¨˜éŒ„ç•¶å‰é¸ä¸­çš„æœˆä»½
    let db = JSON.parse(localStorage.getItem('goal_final_v26')) || { daily_history: {}, daily_ticks: {}, daily_emojis: {}, weekly: {}, monthly: {}, weekly_ticks: {}, monthly_ticks: {} };

    function fireCheckboxConfetti(el) { if (el.checked) confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#E57373', '#D4A5A5', '#FFF'] }); }

    function initPage() {
        const today = new Date();
        selectedWeek = Math.ceil((today.getDate() + new Date(today.getFullYear(), today.getMonth(), 1).getDay()) / 7);
        selectedMonth = today.getMonth() + 1;
        loadDayData(today); 
    }

    function loadDayData(targetDate) {
        activeDate = new Date(targetDate);
        const key = activeDate.toDateString();
        const dayOfWeek = activeDate.getDay();
        document.getElementById('current-date').innerText = activeDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const ticks = db.daily_ticks[key] || [];
        document.querySelectorAll('#daily .item-card:not(.sweets-zone)').forEach((item, i) => {
            const allowed = item.getAttribute('data-days');
            const cb = item.querySelector('input');
            if (allowed) {
                const isRest = !allowed.split(',').includes(dayOfWeek.toString());
                item.classList.toggle('rest-day', isRest);
                cb.disabled = isRest;
            } else {
                item.classList.remove('rest-day');
                cb.disabled = false;
            }
            cb.checked = !cb.disabled && (ticks[i] || false);
        });
        updateEmojiUI();
        update(false); 
        refreshStats();
    }

    function loadWeekData(wIdx) {
        selectedWeek = wIdx;
        checkWeeklyAuto(false, wIdx);
        const key = `${activeDate.getFullYear()}-${activeDate.getMonth()+1}-W${wIdx}`;
        const ticks = db.weekly_ticks[key] || [false, false];
        document.getElementById('week-cardio-cb').checked = ticks[0];
        document.getElementById('week-strength-cb').checked = ticks[1];
        update(false);
        refreshStats();
    }

    function loadMonthData(mIdx) {
        selectedMonth = mIdx;
        const key = `${activeDate.getFullYear()}-M${mIdx}`;
        const ticks = db.monthly_ticks[key] || [false, false, false];
        const inputs = document.querySelectorAll('#monthly input[type="checkbox"]');
        inputs.forEach((input, i) => {
            input.checked = ticks[i] || false;
        });
        update(false);
        refreshStats();
    }

    function addHeart(emoji) {
        const key = activeDate.toDateString();
        db.daily_emojis[key] = (db.daily_emojis[key] || "") + emoji;
        if (emoji === 'â¤ï¸') confetti({ particleCount: 60, spread: 80, origin: { y: 0.8 }, colors: ['#FF6B6B'] });
        updateEmojiUI();
        update();
    }

    function formatEmojis(str) {
        if (!str) return "";
        return str.split('').map(char => char === 'â¤ï¸' ? '<span class="emoji-heart">â¤ï¸</span>' : char === 'ğŸ’”' ? '<span class="emoji-broken">ğŸ’”</span>' : char).join('');
    }

    function updateEmojiUI() {
        const raw = db.daily_emojis[activeDate.toDateString()] || "";
        document.getElementById('today-emoji-status').innerHTML = `ä»Šæ—¥æˆ°æ³ï¼š${formatEmojis(raw) || 'å°šæœªæœ‰è³‡æ–™'}`;
    }

    function update(save = true) {
        const activeTab = document.getElementById(currentTab);
        const inputs = Array.from(activeTab.querySelectorAll('input[type="checkbox"]'));
        const activeInputs = inputs.filter(i => !i.disabled);
        const checked = activeInputs.filter(i => i.checked);
        let percent = activeInputs.length ? Math.round((checked.length / activeInputs.length) * 100) : 0;
        
        if(currentTab === 'daily') {
            const key = activeDate.toDateString();
            const emo = db.daily_emojis[key] || "";
            percent = Math.min(100, Math.max(0, percent + (emo.match(/â¤ï¸/g)||[]).length - (emo.match(/ğŸ’”/g)||[]).length));
            inputs.forEach(i => i.parentElement.classList.contains('item-card') && i.parentElement.classList.toggle('completed', i.checked));
            if(save) {
                db.daily_history[key] = percent;
                db.daily_ticks[key] = inputs.map(i => i.checked);
                checkWeeklyAuto(true);
            }
        } else if(currentTab === 'weekly') {
            const key = `${activeDate.getFullYear()}-${activeDate.getMonth()+1}-W${selectedWeek}`;
            inputs.forEach(i => i.parentElement.classList.toggle('completed', i.checked));
            if(save) {
                const cardioDone = document.getElementById('week-cardio-cb').checked;
                const strengthDone = document.getElementById('week-strength-cb').checked;
                db.weekly_ticks[key] = [cardioDone, strengthDone];
                db.weekly[key] = (cardioDone && strengthDone);
            }
        } else if(currentTab === 'monthly') {
            const key = `${activeDate.getFullYear()}-M${selectedMonth}`;
            inputs.forEach(i => i.parentElement.classList.toggle('completed', i.checked));
            if(save) {
                db.monthly_ticks[key] = inputs.map(i => i.checked);
                db.monthly[key] = (percent === 100);
            }
        }

        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('percent-text').innerText = percent + '%';
        if(save) { refreshStats(); localStorage.setItem('goal_final_v26', JSON.stringify(db)); }
    }

    function checkWeeklyAuto(isDailyCall = false, targetWeekIdx = null) {
        const weekToCalc = targetWeekIdx || selectedWeek;
        const year = activeDate.getFullYear();
        const month = activeDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const startDay = (weekToCalc - 1) * 7 - firstDayOfMonth + 1;
        const start = new Date(year, month, startDay);
        let c=0, s=0;
        for(let i=0; i<7; i++){
            const checkDate = new Date(start);
            checkDate.setDate(start.getDate() + i);
            const ticks = db.daily_ticks[checkDate.toDateString()];
            if(ticks){ if(ticks[0]) c++; if(ticks[1]) s++; }
        }
        document.getElementById('cardio-count-label').innerText = `${c}/3`;
        document.getElementById('strength-count-label').innerText = `${s}/2`;
        const key = `${year}-${month+1}-W${weekToCalc}`;
        const cardioDone = (c >= 3);
        const strengthDone = (s >= 2);
        if (selectedWeek === weekToCalc) {
            document.getElementById('week-cardio-cb').checked = cardioDone;
            document.getElementById('week-strength-cb').checked = strengthDone;
        }
        db.weekly_ticks[key] = [cardioDone, strengthDone];
        db.weekly[key] = (cardioDone && strengthDone);
    }

    function refreshStats() {
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(w => { const el = document.createElement('div'); el.className = 'weekday-label'; el.innerText = w; grid.appendChild(el); });
        const year = activeDate.getFullYear(), month = activeDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++){
            const dObj = new Date(year, month, d), dKey = dObj.toDateString(), p = db.daily_history[dKey] || 0;
            const cell = document.createElement('div'); cell.className = `calendar-cell ${dKey === activeDate.toDateString()?'active-edit':''} ${p>=100?'cell-perfect':p>=50?'cell-good':p>0?'cell-started':''}`;
            cell.innerHTML = `<b>${d}</b><span style="font-size:0.5rem">${p}%</span><div class="emoji-trail">${formatEmojis(db.daily_emojis[dKey])}</div>`;
            cell.onclick = () => loadDayData(dObj); grid.appendChild(cell);
        }
        const wGrid = document.getElementById('weekly-grid'); wGrid.innerHTML = '';
        for(let w=1; w<=Math.ceil((daysInMonth + firstDay) / 7); w++){
            const done = db.weekly[`${year}-${month+1}-W${w}`];
            const box = document.createElement('div'); box.className = `week-box ${done?'week-done':''} ${w===selectedWeek?'active-week':''}`;
            box.innerText = `ç¬¬${w}é€±`; box.onclick = () => loadWeekData(w); wGrid.appendChild(box);
        }
        const mTrack = document.getElementById('monthly-track'); mTrack.innerHTML = '';
        for(let m=1; m<=12; m++){
            const done = db.monthly[`${year}-M${m}`];
            const circle = document.createElement('div'); circle.className = `month-circle ${done?'month-done':''} ${m===selectedMonth?'active-month':''}`; 
            circle.innerText = m+'æœˆ'; circle.onclick = () => loadMonthData(m); mTrack.appendChild(circle);
        }
    }

    function showTab(id) {
        currentTab = id;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        ['panel-daily','panel-weekly','panel-monthly'].forEach(p => document.getElementById(p).style.display = p.includes(id)?'block':'none');
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-'+id).classList.add('active');
        update(false);
    }
    window.onload = initPage;
</script>
</body>
</html>

